<!doctype html>
<html lang="pt-BR">
<head>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="assets/style.css" />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diário de Viagens — Modern</title>
  <meta name="description" content="Registre suas memórias de viagem de forma simples e segura." />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 via-white to-slate-50 min-h-screen text-slate-800">

  <div id="toast">Memória salva com sucesso!</div>

  <header class="bg-white/80 backdrop-blur sticky top-0 z-20 border-b">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-emerald-500 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">DV</div>
        <div>
          <h1 class="text-xl font-semibold leading-none">Diário de Viagens</h1>
          <p class="text-sm text-slate-500">Registre suas memórias — simples, rápido e seguro no navegador.</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btn-citacao" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white shadow hover:bg-indigo-700 transition"> 
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 21H7a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4h2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 17h6l4 4V7a4 4 0 0 0-4-4h-2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Citação do Dia
        </button>
      </div>
    </div>
  </header>

  <section id="hero" class="relative h-[70vh] flex items-center justify-center text-center text-white">
    <img src="src/viagem.jpg" alt="Paisagem de viagem" class="absolute inset-0 w-full h-full object-cover -z-10">
    <div class="absolute inset-0 bg-black/50 -z-10"></div>
    <div class="max-w-2xl px-6">
      <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-4">Explore. Sonhe. Descubra.</h1>
      <p class="text-lg md:text-xl text-slate-200 mb-6">Guarde suas memórias de viagem e inspire outras pessoas.</p>
      <a href="#form" class="inline-block px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium shadow-lg transition transform hover:scale-105">Adicionar Memória</a>
    </div>
  </section>

  <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

    <!-- Modal do Mapa -->
    <div id="mapModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-2xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 p-4 relative">
        <button id="closeMap" class="absolute top-3 right-3 text-slate-500 hover:text-red-500 text-xl" aria-label="Fechar">&times;</button>
        <h2 class="text-lg font-semibold mb-2">Selecione o Local</h2>
        <div id="map" class="w-full h-96 rounded-lg"></div>
        <div class="flex justify-end gap-3 mt-4">
          <button id="saveLocation" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">Confirmar Local</button>
        </div>
      </div>
    </div>

    <!-- Form -->
    <aside class="col-span-1">
      <form id="formEntrada" novalidate class="card bg-white rounded-2xl p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Nova Memória</h2>
          <small class="text-xs text-slate-400">Campos com * são obrigatórios</small>
        </div>
        <div class="grid grid-cols-1 gap-3">
          <label class="block">
            <span class="text-xs text-slate-600 uppercase">Título do Local *</span>
            <input type="text" id="titulo" name="titulo" required class="mt-1 block w-full rounded-lg border border-slate-200 p-3 shadow-sm focus:ring-2 focus:ring-indigo-200 transition" placeholder="Ex: Praia do Campeche" />
          </label>
          <div class="grid grid-cols-2 gap-3">
            <label class="block">
              <span class="text-xs text-slate-600 uppercase">Data da Visita *</span>
              <input type="date" id="data" name="data" required class="mt-1 block w-full rounded-lg border border-slate-200 p-3 shadow-sm focus:ring-2 focus:ring-indigo-200 transition" />
            </label>
            <label class="block">
              <span class="text-xs text-slate-600 uppercase">Avaliação</span>
              <div class="mt-1 flex items-center gap-3">
                <input type="range" id="avaliacao" name="avaliacao" min="1" max="5" value="4" class="w-full" />
                <output id="avalOutput" class="w-8 text-right text-sm">4</output>
              </div>
            </label>
          </div>
          <label class="block">
            <span class="text-xs text-slate-600 uppercase">Link para uma foto (opcional)</span>
            <input type="url" id="foto" name="foto" placeholder="https://exemplo.com/foto.jpg" class="mt-1 block w-full rounded-lg border border-slate-200 p-3 shadow-sm focus:ring-2 focus:ring-indigo-200 transition" />
          </label>
          <label class="block">
            <span class="text-xs text-slate-600 uppercase">Descrição *</span>
            <textarea id="descricao" name="descricao" minlength="15" required rows="4" class="mt-1 block w-full rounded-lg border border-slate-200 p-3 shadow-sm focus:ring-2 focus:ring-indigo-200 transition" placeholder="Conte sobre sua experiência (mín. 15 caracteres)"></textarea>
          </label>

          <input type="hidden" id="lat" name="lat" />
          <input type="hidden" id="lng" name="lng" />

          <div class="flex gap-3 flex-wrap">
            <button type="button" id="btnGeo" class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border bg-emerald-600 text-white shadow hover:bg-emerald-700 transition"> 
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 2v2m0 16v2m8-8h-2M4 12H2m15.364-6.364l-1.414 1.414M7.05 16.95l-1.414 1.414M16.95 16.95l1.414 1.414M7.05 7.05L5.636 5.636"/></svg>
              Adicionar Localização
            </button>
            <button type="submit" class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-600 to-indigo-500 text-white shadow hover:from-indigo-700 transition transform hover:scale-105"> 
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Salvar Memória
            </button>
          </div>
          <p id="msgGeo" class="text-sm text-slate-500"></p>
        </div>
        <footer class="pt-3 border-t mt-2 text-xs text-slate-400">Yasmin • <span id="ano"></span></footer>
      </form>
    </aside>

    <!-- Entradas -->
    <section id="entradas" class="col-span-2 space-y-4">
      <div id="vazio" class="text-center text-slate-500 p-8 bg-white rounded-2xl card">Nenhuma memória ainda. Use o formulário para adicionar.</div>
    </section>
  </main>

  <!-- Citação -->
  <div class="max-w-6xl mx-auto p-6">
    <div id="citacaoArea" class="bg-white p-6 rounded-2xl card hidden">
      <div class="flex items-start gap-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-6a4 4 0 0 1 4-4h1"/></svg>
        <div class="flex-1">
          <blockquote id="citacaoTexto" class="italic text-lg text-slate-700"></blockquote>
          <p id="citacaoAutor" class="text-right mt-3 text-sm text-slate-500"></p>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center text-slate-500 mt-10 p-6">
    &copy; <span id="ano"></span> Diário de Viagens. Desenvolvido por Yasmin.
  </footer>

<script>
document.getElementById('ano').textContent = new Date().getFullYear();
const storageKey = 'diarioEntradas';
const toast = document.getElementById('toast');
function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>{toast.style.display='none'},2500); }

const aval = document.getElementById('avaliacao');
const avalOut = document.getElementById('avalOutput');
aval.addEventListener('input',()=>{avalOut.textContent=aval.value;});

const btnGeo = document.getElementById('btnGeo');
const msgGeo = document.getElementById('msgGeo');

const mapModal = document.getElementById('mapModal');
const closeMap = document.getElementById('closeMap');
const saveLocation = document.getElementById('saveLocation');
let map, marker, selectedLatLng = null;

closeMap.addEventListener('click',()=>mapModal.classList.add('hidden'));

function abrirMapa(lat,lng,titulo, selectMode=false){
  mapModal.classList.remove('hidden');
  setTimeout(()=>{
    if(!map){
      map = L.map('map').setView([lat,lng],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
      marker = L.marker([lat,lng]).addTo(map).bindPopup(titulo).openPopup();
    } else {
      map.setView([lat,lng],13);
      marker.setLatLng([lat,lng]).bindPopup(titulo).openPopup();
    }
    if(selectMode){
      map.on('click',onMapClick);
    } else {
      map.off('click',onMapClick);
    }
  },100);
}

function onMapClick(e){
  selectedLatLng = e.latlng;
  if(marker){ marker.setLatLng(selectedLatLng).bindPopup("Local selecionado").openPopup(); }
  else { marker = L.marker(selectedLatLng).addTo(map).bindPopup("Local selecionado").openPopup(); }
}

saveLocation.addEventListener('click',()=>{
  if(selectedLatLng){
    document.getElementById('lat').value = selectedLatLng.lat.toFixed(6);
    document.getElementById('lng').value = selectedLatLng.lng.toFixed(6);
    msgGeo.textContent = `Local salvo: ${selectedLatLng.lat.toFixed(6)}, ${selectedLatLng.lng.toFixed(6)}`;
  }
  mapModal.classList.add('hidden');
});

btnGeo.addEventListener('click',()=>{
  const lat = document.getElementById('lat').value || 0;
  const lng = document.getElementById('lng').value || 0;
  selectedLatLng = null;
  abrirMapa(parseFloat(lat)||0,parseFloat(lng)||0,"Selecione o local",true);
});

function lerEntradas(){ const raw = localStorage.getItem(storageKey); try{ return raw?JSON.parse(raw):[]; }catch(e){console.error(e); return [];} }
function salvarEntradas(arr){ localStorage.setItem(storageKey,JSON.stringify(arr)); }

function renderEntradas(){
  const container=document.getElementById('entradas'); container.innerHTML='';
  const entradas=lerEntradas();
  if(!entradas.length){
    const vazio=document.createElement('div'); vazio.id='vazio'; vazio.className='text-center text-slate-500 p-8 bg-white rounded-2xl card'; vazio.textContent='Nenhuma memória ainda. Use o formulário para adicionar.'; container.appendChild(vazio); return;
  }

  entradas.forEach(e=>{
    const article=document.createElement('article'); article.className='bg-white p-4 rounded-2xl card flex gap-4 items-start';
    const mainDiv=document.createElement('div'); mainDiv.className='flex-1';
    const header=document.createElement('div'); header.className='flex items-baseline justify-between gap-2';
    const h3=document.createElement('h3'); h3.className='font-semibold text-lg'; h3.textContent=e.titulo;
    const small=document.createElement('small'); small.className='text-sm text-slate-400'; small.textContent=new Date(e.data).toLocaleDateString();
    header.appendChild(h3); header.appendChild(small);

    const p=document.createElement('p'); p.className='mt-2 text-sm text-slate-600'; p.textContent=e.descricao;
    const meta=document.createElement('div'); meta.className='mt-3 text-sm text-slate-500';
    meta.innerHTML=`Avaliação: <strong class="text-indigo-600">${e.avaliacao}</strong>`+(e.lat&&e.lng?` • Coordenadas: ${e.lat}, ${e.lng}`:'');

    mainDiv.appendChild(header); mainDiv.appendChild(p); mainDiv.appendChild(meta);

    const figure=document.createElement('figure'); figure.className='w-40 flex-shrink-0 rounded overflow-hidden bg-slate-100';
    const img=document.createElement('img'); img.src=e.foto||'https://via.placeholder.com/150'; img.alt=e.titulo; img.loading='lazy'; img.className='h-28 w-full object-cover'; figure.appendChild(img);

    const btns=document.createElement('div'); btns.className='flex gap-2 mt-2 flex-wrap';
    const btnDel=document.createElement('button'); btnDel.className='px-3 py-1 rounded-lg bg-red-600 text-white text-sm hover:bg-red-700 transition'; btnDel.textContent='Excluir';
    btnDel.addEventListener('click',()=>{
      article.classList.add('fade-out');
      setTimeout(()=>{
        const arr=lerEntradas().filter(x=>x.data!==e.data||x.titulo!==e.titulo);
        salvarEntradas(arr); renderEntradas();
      },300);
    }); btns.appendChild(btnDel);

    if(e.lat&&e.lng){
      const btnMap=document.createElement('button'); btnMap.className='px-3 py-1 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700 transition'; btnMap.textContent='Ver no Mapa';
      btnMap.addEventListener('click',()=>abrirMapa(parseFloat(e.lat),parseFloat(e.lng),e.titulo,false)); btns.appendChild(btnMap);
    }

    article.appendChild(figure); article.appendChild(mainDiv); article.appendChild(btns);
    container.appendChild(article);
  });
}

document.getElementById('formEntrada').addEventListener('submit',e=>{
  e.preventDefault();
  const titulo=document.getElementById('titulo').value.trim();
  const data=document.getElementById('data').value;
  const avaliacao=document.getElementById('avaliacao').value;
  const descricao=document.getElementById('descricao').value.trim();
  const foto=document.getElementById('foto').value.trim();
  const lat=document.getElementById('lat').value;
  const lng=document.getElementById('lng').value;

  if(!titulo || !data || !descricao){
    alert('Preencha todos os campos obrigatórios');
    return;
  }

  const entradas = lerEntradas();
  entradas.push({titulo, data, avaliacao, descricao, foto, lat, lng});
  salvarEntradas(entradas);
  renderEntradas();

  e.target.reset();
  document.getElementById('avalOutput').textContent = '4';
  msgGeo.textContent = '';
  showToast('Memória salva com sucesso!');
});

renderEntradas();

// Citação via API 

document.getElementById('btn-citacao').addEventListener('click', async () => {
  const citacaoArea = document.getElementById('citacaoArea');
  const citacaoTexto = document.getElementById('citacaoTexto');
  const citacaoAutor = document.getElementById('citacaoAutor');

  citacaoTexto.textContent = 'Carregando...';
  citacaoAutor.textContent = '';
  citacaoArea.classList.remove('hidden');

  // utilitário com timeout (evita ficar preso esperando)
  async function fetchWithTimeout(url, timeout = 7000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
      const res = await fetch(url, { cache: 'no-store', signal: controller.signal });
      clearTimeout(id);
      if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + url);
      return await res.json();
    } finally {
      clearTimeout(id);
    }
  }

  // parsers para diferentes formatos possíveis
  function parseFromArrayLike(json) {
    if (!json) return null;
    const arr = Array.isArray(json) ? json : (json.frases || json || []);
    if (!Array.isArray(arr) || !arr.length) return null;
    const it = arr[Math.floor(Math.random() * arr.length)];
    const text = it.frase || it.texto || it.quote || it.text;
    const author = it.autor || it.author || it.autor || 'Desconhecido';
    return text ? { text, author } : null;
  }

  function parseSingleLike(json) {
    if (!json) return null;
    const text = json.frase || json.texto || json.quote || json.content || json.phrase || json.text;
    const author = json.autor || json.author || json.authorName || 'Desconhecido';
    return text ? { text, author } : null;
  }

  // endpoints (em PT primeiro)
  const endpoints = [
    {
      url: 'https://raw.githubusercontent.com/devmatheusguerra/frasesJSON/master/frases.json',
      parser: parseFromArrayLike
    },
    {
      url: 'https://allugofrases.herokuapp.com/frases/random',
      parser: (j) => {
        // AlluGo pode retornar objeto ou array
        if (Array.isArray(j) && j.length) return { text: j[0].frase || j[0].texto || j[0].quote, author: j[0].autor || j[0].author || 'Desconhecido' };
        return parseSingleLike(j);
      }
    },
    // fallback em inglês (apenas se tudo em PT falhar) — ainda tentamos traduzir mentalmente com tom filosófico via fallback local se necessário
    {
      url: 'https://api.quotable.io/random?tags=philosophy',
      parser: j => ({ text: j.content, author: j.author || 'Desconhecido' })
    }
  ];

  let succeeded = false;
  for (const ep of endpoints) {
    try {
      const json = await fetchWithTimeout(ep.url, 7000);
      const q = ep.parser(json);
      if (q && q.text) {
        // se a citação vier em inglês e você preferir PT, deixamos — mas aqui mostramos o que houver
        citacaoTexto.textContent = q.text;
        citacaoAutor.textContent = '— ' + (q.author || 'Desconhecido');
        succeeded = true;
        break;
      }
    } catch (err) {
      // erro de fetch / CORS / timeout — seguimos para o próximo endpoint
      console.warn('Erro ao acessar', ep.url, err && err.message ? err.message : err);
    }
  }

  // se nenhuma endpoint funcionou, usa fallback local (garante sempre resultado em PT)
  if (!succeeded) {
    const item = localQuotes[Math.floor(Math.random() * localQuotes.length)];
    citacaoTexto.textContent = item.text;
    citacaoAutor.textContent = '— ' + (item.author || 'Desconhecido');
    console.info('Usando citação local (fallback).');
  }
});

</script>
</body>
</html>
